<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>BaaS —Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —Ç–µ–ª–µ—Ñ–æ–Ω–∞</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 500px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        input[readonly] { background: #f8f9fa; }
        button#mainBtn { background: #007bff; color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; font-weight: 600; cursor: pointer; transition: 0.3s; }
        button#mainBtn:disabled { background: #6c757d; cursor: not-allowed; }
        .post { background: #fff; border: 1px solid #eaeaea; padding: 15px; margin-top: 15px; border-radius: 8px; width: 100%; max-width: 500px; position: relative; }
        .like-btn { cursor: pointer; border: none; background: #f8f9fa; padding: 5px 12px; border-radius: 20px; font-size: 14px; transition: 0.2s; }
        .like-btn:hover { background: #e2e6ea; }
        .time { font-size: 11px; color: #999; float: right; }
        .phone-display { font-size: 13px; color: #28a745; margin: 2px 0; }
        .status { font-size: 12px; color: #666; margin-top: 5px; text-align: center; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
    </style>
</head>
<body>

    <div class="container">
        <h3>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏</h3>
        <input type="text" id="name" placeholder="–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)" required>
        <input type="email" id="email" placeholder="–†–∞–±–æ—á–∏–π Email" required>
        <input type="tel" id="phone" placeholder="+77001234567 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)">
        <div id="status" class="status"></div>
        <button id="mainBtn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
    </div>

    <div id="feed" style="width: 100%; max-width: 500px;"></div>

    <script type="module">
        // === –ü–û–õ–ù–´–ô –ö–û–î –° –í–ï–†–ò–§–ò–ö–ê–¶–ò–ï–ô PHONE ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot,
            serverTimestamp, updateDoc, doc, increment, getDoc, setDoc 
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDDQUDZAHu1eYxxEAjG1n0d1AfcUXtz1jE",
            authDomain: "is-po233.firebaseapp.com",
            projectId: "is-po233",
            storageBucket: "is-po233.firebasestorage.app",
            messagingSenderId: "1083602801160",
            appId: "1:1083602801160:web:5f033d32c2d9efb0cbf7bd",
            measurementId: "G-P5JR939L0K"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let authReady = false;

        // === –§–£–ù–ö–¶–ò–Ø 1: –ü–†–û–í–ï–†–ö–ê –£–ù–ò–ö–ê–õ–¨–ù–û–°–¢–ò PHONE ===
        window.checkPhoneUnique = async (phone) => {
            // Regex E.164: +? + 1-15 —Ü–∏—Ñ—Ä (–±–µ–∑ –±—É–∫–≤)
            if (!phone?.match(/^[+]?[1-9]\d{1,14}$/)) {
                throw new Error("–§–æ—Ä–º–∞—Ç: +77001234567 –∏–ª–∏ 77001234567");
            }

            // –ñ–¥–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            await waitForAuth();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º existence –≤ –∏–Ω–¥–µ–∫—Å–µ /phones/{phone}
            const phoneDocRef = doc(db, "phones", phone);
            const phoneDoc = await getDoc(phoneDocRef);
            if (phoneDoc.exists()) {
                throw new Error("–≠—Ç–æ—Ç –Ω–æ–º–µ—Ä —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
            }
            return true;
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è: –æ–∂–∏–¥–∞–Ω–∏–µ auth
        const waitForAuth = () => {
            return new Promise((resolve) => {
                if (authReady) return resolve();
                const unsubscribe = onAuthStateChanged(auth, () => {
                    if (auth.currentUser) {
                        authReady = true;
                        unsubscribe();
                        resolve();
                    }
                });
            });
        };

        // === –§–£–ù–ö–¶–ò–Ø 2: –ê–¢–û–ú–ê–†–ù–´–ô –õ–ê–ô–ö ===
        window.processLike = async (id) => {
            const docRef = doc(db, "requests", id);
            try {
                await updateDoc(docRef, { likes: increment(1) });
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞:", e.message);
            }
        };

        // === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–û–ó–î–ê–ù–ò–ï –ü–û–°–¢–ê ===
        document.getElementById('mainBtn').onclick = async () => {
            const btn = document.getElementById('mainBtn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            btn.textContent = "–ü—É–±–ª–∏–∫–∞—Ü–∏—è...";
            status.textContent = "";
            status.className = "status";

            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim() || null;

            try {
                // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
                if (name.length < 3) throw new Error("–ò–º—è: –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞");
                if (!email.match(/.*@.*\..*/)) throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email");

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ phone (–µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω)
                if (phone) {
                    status.textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–º–µ—Ä...";
                    await window.checkPhoneUnique(phone);
                    status.innerHTML = '<span class="success">‚úÖ –ù–æ–º–µ—Ä —É–Ω–∏–∫–∞–ª–µ–Ω</span>';
                }

                // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                await waitForAuth();

                // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
                status.textContent = "–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ...";
                const docRef = await addDoc(collection(db, "requests"), {
                    name,
                    email,
                    phone,
                    likes: 0,
                    uid: auth.currentUser.uid,
                    timestamp: serverTimestamp()
                });

                // –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ phone
                if (phone) {
                    await setDoc(doc(db, "phones", phone), {
                        claimedBy: auth.currentUser.uid,
                        requestId: docRef.id,
                        createdAt: serverTimestamp()
                    });
                }

                // –£—Å–ø–µ—Ö
                document.getElementById('name').value = "";
                document.getElementById('email').value = "";
                document.getElementById('phone').value = "";
                status.innerHTML = '<span class="success">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!</span>';
                
            } catch (e) {
                status.innerHTML = '<span class="error">‚ùå ' + e.message + '</span>';
                console.error("–û—à–∏–±–∫–∞:", e);
            } finally {
                btn.disabled = false;
                btn.textContent = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞–∫–æ";
            }
        };

        // === REAL-TIME –§–ò–î ===
        const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            snapshot.forEach((docSnapshot) => {
                const data = docSnapshot.data();
                const phoneHtml = data.phone ? `<div class="phone-display">üì± ${data.phone}</div>` : '';
                feed.innerHTML += `
                    <div class="post">
                        <span class="time">${data.timestamp?.toDate().toLocaleTimeString() || '...'}</span>
                        <b>${data.name}</b>
                        <p style="margin: 5px 0;">${data.email}</p>
                        ${phoneHtml}
                        <button class="like-btn" onclick="processLike('${docSnapshot.id}')">
                            üëç ${data.likes || 0}
                        </button>
                    </div>
                `;
            });
        });
    </script>
</body>
</html>
