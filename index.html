<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BaaS + Auth + Image Upload</title>

<style>
* { box-sizing: border-box; transition: all 0.2s ease; }
body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: #f0f2f5;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin: 0;
    color: #1c1e21;
}
.container {
    width: 100%;
    max-width: 500px;
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,.08);
    margin-bottom: 16px;
}
.auth-bar {
    background: #fff;
    padding: 12px;
    border-radius: 12px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
    width: 100%;
    max-width: 500px;
}
.user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: 2px solid #007bff;
    object-fit: cover;
}
.logout-btn {
    background: #fee2e2;
    color: #dc2626;
    padding: 8px 16px;
    font-size: 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-left: auto;
}
input {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
}
button {
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
}
#mainBtn { background: #007bff; color: white; width: 100%; }
#mainBtn:hover { background: #0056b3; }

.post {
    background: white;
    border: 1px solid #e5e7eb;
    padding: 16px;
    margin-top: 12px;
    border-radius: 12px;
    width: 100%;
}
.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
}
.post-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}
.like-btn {
    margin-top: 10px;
    padding: 6px 14px;
    border-radius: 20px;
    background: #f0f2f5;
}
.search-box {
    width: 100%;
    max-width: 500px;
}
</style>
</head>

<body>

<div id="authSection" class="container" style="text-align:center;">
    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
    <button id="loginBtn" style="background:#4285F4; color:white;">
        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
    </button>
</div>

<div id="userInfo" style="display:none" class="auth-bar">
    <img id="userPhoto" class="user-avatar">
    <span id="userName" style="font-weight:bold"></span>
    <button id="logoutBtn" class="logout-btn">–í—ã–π—Ç–∏</button>
</div>

<div id="messageForm" class="container" style="display:none">
    <h3>–ù–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
    <input type="text" id="nameDisplay" readonly>
    <input type="text" id="contentInput" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?">
    <input type="file" id="imageInput" accept="image/*">
    <button id="mainBtn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</div>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∞–≤—Ç–æ—Ä–æ–≤...">
</div>

<div id="feed" style="width:100%; max-width:500px"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
    getFirestore, collection, addDoc, query, orderBy, onSnapshot,
    serverTimestamp, updateDoc, doc, increment,
    where, getDocs, limit
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import {
    getAuth, signInWithPopup, GoogleAuthProvider,
    signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import {
    getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDDQUDZAHu1eYxxEAjG1n0d1AfcUXtz1jE",
  authDomain: "is-po233.firebaseapp.com",
  projectId: "is-po233",
  storageBucket: "is-po233.firebasestorage.app",
  messagingSenderId: "1083602801160",
  appId: "1:1083602801160:web:5f033d32c2d9efb0cbf7bd",
  measurementId: "G-P5JR939L0K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();

const feed = document.getElementById('feed');
const contentInput = document.getElementById('contentInput');
const imageInput = document.getElementById('imageInput');
const mainBtn = document.getElementById('mainBtn');

document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);
document.getElementById('logoutBtn').onclick = () => signOut(auth);

onAuthStateChanged(auth, user => {
    if (user) {
        authSection.style.display = 'none';
        userInfo.style.display = 'flex';
        messageForm.style.display = 'block';
        userName.innerText = user.displayName;
        userPhoto.src = user.photoURL;
        nameDisplay.value = user.displayName;
    } else {
        authSection.style.display = 'block';
        userInfo.style.display = 'none';
        messageForm.style.display = 'none';
    }
});

function createPostHTML(d) {
    const data = d.data();
    return `
    <div class="post">
        <div class="post-header">
            <img src="${data.photo}" class="post-avatar">
            <strong>${data.name}</strong>
        </div>
        <p>${data.text || ""}</p>
        ${data.image ? `<img src="${data.image}" style="width:100%; border-radius:10px;">` : ""}
        <button class="like-btn" onclick="window.processLike('${d.id}')">
            üëç ${data.likes || 0}
        </button>
    </div>`;
}

const q = query(collection(db, "requests"), orderBy("timestamp", "desc"), limit(30));
onSnapshot(q, snapshot => {
    feed.innerHTML = "";
    snapshot.forEach(doc => {
        feed.innerHTML += createPostHTML(doc);
    });
});

mainBtn.onclick = async () => {
    const text = contentInput.value.trim();
    const file = imageInput.files[0];

    if (!text && !file) return alert("–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!");

    mainBtn.disabled = true;

    try {
        let imageUrl = null;

        if (file) {
            const imageRef = ref(storage, `posts/${Date.now()}_${file.name}`);
            await uploadBytes(imageRef, file);
            imageUrl = await getDownloadURL(imageRef);
        }

        await addDoc(collection(db, "requests"), {
            name: auth.currentUser.displayName,
            photo: auth.currentUser.photoURL,
            text: text || "",
            image: imageUrl,
            likes: 0,
            timestamp: serverTimestamp()
        });

        contentInput.value = "";
        imageInput.value = "";

    } catch (e) {
        alert("–û—à–∏–±–∫–∞: " + e.message);
    }

    mainBtn.disabled = false;
};

window.processLike = async (id) => {
    const postRef = doc(db, "requests", id);
    await updateDoc(postRef, { likes: increment(1) });
};

document.getElementById('searchInput').oninput = async (e) => {
    const term = e.target.value.trim();
    if (!term) return;

    const q = query(
        collection(db, "requests"),
        where("name", ">=", term),
        where("name", "<=", term + "\uf8ff"),
        limit(20)
    );

    const snap = await getDocs(q);
    feed.innerHTML = "";
    snap.forEach(doc => {
        feed.innerHTML += createPostHTML(doc);
    });
};

</script>
</body>
</html>
